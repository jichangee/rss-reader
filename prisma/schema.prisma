// Prisma schema for RSS Reader

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("RSS_DATABASE_URL")
}

// 用户模型
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  role          String    @default("user") // 用户角色: user, admin
  targetLanguage String?  @default("zh") // 翻译目标语言，默认中文
  translationProvider String? // 翻译服务提供商: google, niutrans, microsoft
  googleTranslateApiKey String? // Google 翻译 API Key
  niutransApiKey String? // 小牛翻译 API Key
  niutransApiSecret String? // 小牛翻译 API Secret
  microsoftTranslateApiKey String? // 微软翻译 API Key
  microsoftTranslateRegion String? // 微软翻译服务区域
  markReadOnScroll Boolean @default(false) // 是否启用滚动标记已读
  autoRefreshOnLoad Boolean @default(true) // 首次进入页面时自动刷新，默认开启
  hideImagesAndVideos Boolean @default(false) // 是否隐藏图片和视频
  lastRefreshRequestAt DateTime? // 用户最后一次刷新请求时间，用于限制刷新频率
  lastActiveAt  DateTime? // 用户最后活跃时间
  accounts      Account[]
  sessions      Session[]
  feeds         Feed[]
  readArticles  ReadArticle[]
  readLater     ReadLater[]
  webhooks      Webhook[]
  userActivities UserActivity[]
  adminLogs     AdminLog[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([role])
  @@index([lastActiveAt])
}

// NextAuth Account模型
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

// NextAuth Session模型
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// NextAuth VerificationToken模型
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// RSS订阅源模型
model Feed {
  id                String        @id @default(cuid())
  url               String
  title             String
  description       String?
  link              String?
  imageUrl          String?
  enableTranslation Boolean       @default(false) // 是否启用翻译
  userId            String
  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  articles          Article[]
  webhooks          FeedWebhook[]
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  lastRefreshedAt   DateTime?     // 上次刷新时间

  @@unique([userId, url])
}

// RSS文章模型
model Article {
  id          String        @id @default(cuid())
  feedId      String
  feed        Feed          @relation(fields: [feedId], references: [id], onDelete: Cascade)
  title       String
  link        String
  content     String?
  contentSnippet String?
  pubDate     DateTime?
  author      String?
  guid        String
  readBy      ReadArticle[]
  readLaterBy ReadLater[]
  hotness     ArticleHotness?
  createdAt   DateTime      @default(now())

  @@unique([feedId, guid])
}

// 已读文章记录
model ReadArticle {
  id        String   @id @default(cuid())
  userId    String
  articleId String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  article   Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  readAt    DateTime @default(now())

  @@unique([userId, articleId])
}

// 稍后读文章记录
model ReadLater {
  id        String   @id @default(cuid())
  userId    String
  articleId String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  article   Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  addedAt   DateTime @default(now())

  @@unique([userId, articleId])
}

// Webhook 模型
model Webhook {
  id            String        @id @default(cuid())
  userId        String
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  name          String        // Webhook 名称
  url           String        // 目标 URL
  method        String        @default("POST") // 请求方法: GET 或 POST
  customFields  String?       @db.Text // 自定义字段映射 JSON: [{"name": "url", "value": "{link}"}]
  remote        Boolean       @default(true) // 是否由服务器端发起请求
  enabled       Boolean       @default(true) // 是否启用
  feeds         FeedWebhook[]
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([userId])
}

// Feed-Webhook 多对多关联表
model FeedWebhook {
  id        String   @id @default(cuid())
  feedId    String
  webhookId String
  feed      Feed     @relation(fields: [feedId], references: [id], onDelete: Cascade)
  webhook   Webhook  @relation(fields: [webhookId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([feedId, webhookId])
  @@index([feedId])
  @@index([webhookId])
}

// 用户活跃度统计表
model UserActivity {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  date         DateTime @db.Date
  actions      Int      @default(0) // 操作次数
  articlesRead Int      @default(0) // 阅读文章数
  createdAt    DateTime @default(now())
  
  @@unique([userId, date])
  @@index([date])
  @@index([userId])
}

// 系统统计快照表（每天凌晨生成）
model SystemStats {
  id              String   @id @default(cuid())
  date            DateTime @db.Date @unique
  totalUsers      Int      @default(0)
  newUsers        Int      @default(0)
  activeUsers     Int      @default(0) // DAU
  totalFeeds      Int      @default(0)
  newFeeds        Int      @default(0)
  totalArticles   Int      @default(0)
  newArticles     Int      @default(0)
  totalReads      Int      @default(0)
  newReads        Int      @default(0)
  createdAt       DateTime @default(now())
  
  @@index([date])
}

// 管理员操作日志
model AdminLog {
  id          String   @id @default(cuid())
  adminId     String
  admin       User     @relation(fields: [adminId], references: [id], onDelete: Cascade)
  action      String   // view_dashboard, update_user, delete_user, etc.
  targetType  String?  // user, feed, article, system
  targetId    String?
  details     String?  @db.Text // JSON格式的详细信息
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())
  
  @@index([adminId])
  @@index([createdAt])
  @@index([action])
}

// 文章热度统计表（定时计算更新）
model ArticleHotness {
  id              String   @id @default(cuid())
  articleId       String   @unique
  article         Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  readLaterCount  Int      @default(0)  // 稍后读次数
  readCount       Int      @default(0)  // 阅读次数
  uniqueUsers     Int      @default(0)  // 影响的独立用户数
  hotScore        Float    @default(0)  // 热度分数
  lastCalculated  DateTime @default(now())
  createdAt       DateTime @default(now())
  
  @@index([hotScore, lastCalculated])
  @@index([createdAt])
}

// 邮箱验证码表
model EmailVerificationCode {
  id        String   @id @default(cuid())
  email     String
  code      String   // 6位数字验证码
  expiresAt DateTime // 过期时间（5分钟）
  used      Boolean  @default(false) // 是否已使用
  createdAt DateTime @default(now())
  
  @@index([email, code])
  @@index([expiresAt])
}

