# 管理后台部署指南

## 📋 功能概述

管理后台提供以下核心功能：

### ✅ 已实现功能

#### 1. **数据统计仪表板** (`/admin`)
   - 用户统计（总数、新增、日活/周活/月活）
   - 订阅源和文章统计
   - 阅读行为统计
   - 用户增长趋势折线图（SVG 图表）
   - 热门订阅源 Top 10

#### 2. **用户管理** (`/admin/users`)
   - 用户列表查看（支持搜索、角色筛选、分页）
   - 显示用户基本信息、角色、统计数据
   - 显示注册时间和最后活跃时间
   - 用户角色管理
   - 删除用户功能（防止删除自己）

#### 3. **订阅源管理** (`/admin/feeds`)
   - 订阅源列表展示（支持搜索、排序、分页）
   - 显示订阅源详细信息（标题、URL、所有者、文章数、最后刷新时间）
   - 单个订阅源刷新功能
   - 批量刷新所有订阅源功能
   - 删除订阅源功能
   - 外部链接跳转

#### 4. **文章管理** (`/admin/articles`)
   - 文章列表展示（支持搜索、分页）
   - 显示文章详细信息（标题、订阅源、阅读数、稍后读数、发布时间）
   - 批量选择文章功能
   - 批量删除选中文章
   - 单个文章删除功能
   - 文章链接外部跳转

#### 5. **系统设置** (`/admin/settings`)
   - 系统统计概览（总用户数、总订阅源、总文章数）
   - 环境配置状态检查（运行环境、管理员邮箱、Cron Secret、翻译API）
   - 管理员列表展示
   - 操作日志查看（支持按操作类型筛选、分页）
   - 显示日志详细信息（时间、管理员、操作类型、目标、IP地址）

#### 6. **权限系统**
   - 基于角色的访问控制（user / admin）
   - 管理员操作日志记录
   - 环境变量配置管理员
   - 所有管理操作都有日志追踪

#### 7. **统计数据汇总**
   - 定时任务每日汇总统计数据
   - 用户活跃度追踪
   - 系统快照记录

---

## 🚀 部署步骤

### 1. 更新数据库 Schema

首先需要更新数据库结构，添加管理后台所需的表和字段：

```bash
# 生成 Prisma 迁移
npx prisma migrate dev --name add_admin_features

# 或者直接推送到数据库
npx prisma db push

# 重新生成 Prisma Client
npx prisma generate
```

### 2. 配置环境变量

在 `.env` 文件中添加管理员邮箱配置：

```env
# 管理员邮箱（多个邮箱用逗号分隔）
ADMIN_EMAILS="your-admin-email@gmail.com,another-admin@gmail.com"
```

**注意：**
- 只有在 `ADMIN_EMAILS` 中列出的邮箱才能访问管理后台
- 用户首次登录后，系统会自动将其角色设置为 `admin`

### 3. 测试定时任务（可选）

统计数据汇总定时任务配置在 `vercel.json` 中：

```json
{
  "crons": [
    {
      "path": "/api/cron/aggregate-stats",
      "schedule": "0 1 * * *"  // 每天凌晨 1:00 执行
    }
  ]
}
```

本地测试定时任务：

```bash
# 使用 curl 测试（需要 CRON_SECRET）
curl -H "Authorization: Bearer YOUR_CRON_SECRET" \
  http://localhost:3000/api/cron/aggregate-stats
```

### 4. 部署到 Vercel

```bash
# 推送代码到 Git 仓库
git add .
git commit -m "feat: add admin dashboard"
git push origin main

# Vercel 会自动部署
```

**Vercel 环境变量配置：**

在 Vercel 项目设置中添加以下环境变量：
1. `ADMIN_EMAILS` - 管理员邮箱列表
2. `CRON_SECRET` - 定时任务密钥（如果还没有的话）

---

## 📖 使用指南

### 访问管理后台

1. 使用管理员邮箱登录系统
2. 访问 `/admin` 路径
3. 系统会自动验证您的管理员权限

### 管理后台路由

- `/admin` - 数据统计仪表板 ✅
- `/admin/users` - 用户管理 ✅
- `/admin/feeds` - 订阅源管理 ✅
- `/admin/articles` - 文章管理 ✅
- `/admin/settings` - 系统设置 ✅

### 权限说明

- **普通用户 (user)**: 只能访问前台功能
- **管理员 (admin)**: 可以访问管理后台的所有功能

---

## 🔒 安全注意事项

1. **保护管理员邮箱列表**
   - 不要将 `.env` 文件提交到版本控制
   - 定期审查管理员列表

2. **操作日志**
   - 所有管理员操作都会记录到 `AdminLog` 表
   - 包括操作类型、目标、时间、IP 地址等

3. **权限验证**
   - 每个管理后台 API 都会验证用户的管理员权限
   - 使用 `checkAdmin()` 函数进行统一验证

4. **定时任务安全**
   - Cron 端点使用 `CRON_SECRET` 进行保护
   - 只有携带正确密钥的请求才能执行

---

## 🐛 故障排查

### 无法访问管理后台

1. 检查您的邮箱是否在 `ADMIN_EMAILS` 中
2. 退出登录后重新登录，触发角色更新
3. 查看浏览器控制台是否有错误信息

### 统计数据不准确

1. 确保定时任务正常运行
2. 检查 Vercel Cron 日志
3. 手动触发统计任务进行测试

### 数据库错误

```bash
# 重新生成 Prisma Client
npx prisma generate

# 同步数据库结构
npx prisma db push
```

---

## 📊 数据库表结构

### 新增表

1. **UserActivity** - 用户活跃度统计
   - 记录每个用户每天的活动数据
   - 用于计算 DAU/WAU/MAU

2. **SystemStats** - 系统统计快照
   - 每天的系统整体统计数据
   - 用于趋势分析和历史回溯

3. **AdminLog** - 管理员操作日志
   - 记录所有管理员操作
   - 用于审计和安全追踪

### 修改的表

1. **User** - 用户表
   - 新增 `role` 字段（user / admin）
   - 新增 `lastActiveAt` 字段（最后活跃时间）
   - 新增索引提升查询性能

---

## 🎯 后续开发建议

### 可选增强功能
1. **用户详情页面**
   - 更丰富的用户数据展示
   - 用户行为时间线
   - 编辑用户信息

2. **数据导出**
   - 导出用户列表（CSV/Excel）
   - 导出统计报表
   - 导出操作日志

3. **高级图表**
   - 使用 recharts 或 chart.js
   - 更多维度的数据可视化
   - 自定义时间范围分析

4. **通知系统**
   - 邮件通知
   - 系统异常告警
   - 重要操作通知

5. **性能优化**
   - 数据缓存机制
   - 长列表虚拟滚动
   - 图片懒加载

6. **安全增强**
   - 操作二次确认
   - 敏感操作验证码
   - IP 白名单

---

## 📝 开发日志

- **2025-12-10**: 完整版本完成 🎉
  - ✅ 数据库 Schema 更新
  - ✅ 权限系统实现
  - ✅ 数据统计仪表板（含 SVG 图表）
  - ✅ 用户管理功能
  - ✅ 订阅源管理功能
  - ✅ 文章管理功能
  - ✅ 系统设置功能
  - ✅ 操作日志系统
  - ✅ 定时任务配置
  - ✅ 全面使用 shadcn/ui 组件库
  - ✅ 响应式设计和深色模式

---

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！
